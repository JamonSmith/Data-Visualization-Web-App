<!DOCTYPE html>
<html>
	<head> 
		<title> My First Electron App </title>
		<style>
			body { font-family: sans-serif; margin: 20px; }
			textarea {width: 100%; height: 400px; margin-bottom: 10px; font-size: 16px; }
			button { padding: 10px 20px; font-size: 16px }
			pre { background: #e4e4e4; padding: 10px; border-radius: 6px; max-height: 300px; overflow-y: auto; }
			button:disabled { background-color: #ccc; color: #666; cursor: not-allowed: }
		</style>
	</head>
	
	<body>
		<h1> Create a File!! </h1>
		<textarea id="editor" placeholder="Enter text here:"></textarea>
		<div id="warning" style="color:red; display:none;">Enter Text Before Saving</div>
		<br>
		
		<button id="theSaveButton"> Save As </button>
		<br>
		<hr>
		
		<h1> Data Visualization!! </h1>
		
		<button id="theOpenButton"> Open CSV </button>
		
		<h3> Preview </h3>
		<pre id="preview"> (No data loaded) </pre>
		
		<h3> Visual Type </h3>
		<select id="chartSelect">
			<option value="bar"> Bar Graph </option>
			<option value="pie"> Pie Chart </option>
			<option value="line"> Line Graph </option>
		</select>	
		
		<h3> Visual </h3> 
		<canvas id="chart" width="600" height="400"></canvas>
		
		<h3> Choose Columns </h3>
		<div id="colSelect" style="display:none; margin-bottom: 15px;">
			<label for="labelSelect"> Label Column: </label>
			<select id="labelSelect"></select>
			
			<label for="dataSelect" style="margin-left: 15px;"> Data Column: </label>
			<select id="dataSelect"></select>
			
			<button id="updateVizButton" style="margin-left: 15px;"> Update Visual </button>
		</div>

		<button id="theClearButton"> Clear Data </button>
		
		<script src="./node_modules/papaparse/papaparse.min.js"></script>
		<script src="./node_modules/chart.js/dist/chart.umd.js"></script>
		
		<script>
			const editor = document.getElementById("editor");
			const saveButton = document.getElementById("theSaveButton");
			const openButton = document.getElementById("theOpenButton");
			const preview = document.getElementById("preview");
			const warning = document.getElementById("warning");
			
			const labelSelect = document.getElementById("labelSelect");
			const dataSelect = document.getElementById("dataSelect");
			const chartSelect = document.getElementById("chartSelect");
			const colSelect = document.getElementById("colSelect");
			const clearButton = document.getElementById("theClearButton");
			const updateVizButton = document.getElementById("updateVizButton");
			
			let csvData = [];
			let chartInst = null;
			
			// Open CSV File
			openButton.addEventListener("click", () => {
				window.electronAPI.openFile();
			});
			
			// Saving a File
			saveButton.addEventListener("click", () => {
				const content = editor.value.trim();
				
				if (!content)
				{
					warning.style.display = "block";
					//alert("Enter text before saving");
					editor.focus();
					return;
				}
				
				warning.style.display = "none";
				console.log("Saving File");
				window.electronAPI.saveFile(content);
			});
			
			clearButton.disabled = true;

			window.electronAPI.onFileOpened((data) => {
				clearButton.disabled = false;
				
				editor.value = "";
				preview.innerHTML = "(No data loaded)";
				labelSelect.innerHTML = "";
				dataSelect.innerHTML = "";
				colSelect.style.display = "none";
				
				if (chartInst)
				{
					chartInst.destroy();
					chartInst = null;
				}
				
				console.log("CSV Data: ", data);
				csvData = data;
				renderTable(data);
				setDropdowns(data);
				renderChart(data);
			});	
			
			function renderTable(data)
			{
				if (!data || !data.length)
				{
					preview.innerHTML = "<p> No data available </p>";
					return;
				}
				
				const headers = Object.keys(data[0]);
				let html = "<table border='1' cellpadding='5'><tr>";
				headers.forEach(h => html += `<th>${h}</th>`);
				html += "</tr>";
				
				data.forEach(row => {
					html += "<tr>";
					headers.forEach(h => html += `<td>${row[h] || ""}</td>`);
					html += "</tr>";
				});	
				
				html += "</table>";
					
				preview.innerHTML = html;
			}
			
			function setDropdowns(data)
			{
				const headers = Object.keys(data[0]);
				labelSelect.innerHTML = "";
				dataSelect.innerHTML = "";
				
				headers.forEach(h => {
					const option1 = document.createElement("option");
					option1.value = h;
					option1.textContent = h;
					labelSelect.appendChild(option1);
					
					const option2 = document.createElement("option");
					option2.value = h;
					option2.textContent = h;
					dataSelect.appendChild(option2);
				});	
				
				colSelect.style.display = "block";
			}
			
			updateVizButton.addEventListener("click", () => {
				let labelCol = labelSelect.value;
				let dataCol = dataSelect.value;
				const chartType = chartSelect.value;
				
				if (chartType === "pie" && (!dataCol || dataCol === labelCol))
				{
					const headers = Object.keys(csvData[0]);
					dataCol = headers.find(h => h !== labelCol);
				}
				
				renderChart(csvData, labelCol, dataCol, chartType);
			});	
			
			function renderChart(data, labelCol, dataCol, chartType)
			{
				if (!data || !data.length) 
				{
					return;
				}
				
				const headers = Object.keys(data[0]);
				labelCol = labelCol || headers[0];
				chartType = chartType || chartSelect.value;
				
				dataCol = dataCol || headers.find(h => h !== labelCol);
				
				const labels = data.map(row => row[labelCol]);
				
				let datasets;
				
				if (chartType === "pie")
				{
					dataCol = dataCol || headers.find(h => h !== labelCol);
					datasets = [{
						label: labelCol,
						data: data.map(row => parseFloat(row[dataCol]) || 0),
						backgroundColor: data.map((_, index) => `hsl(${index * 60}, 70%, 60%)`)
					}];
				}
				else
				{
					datasets = headers.filter(h => h !== labelCol).map((header, index) => ({
						label: header,
						data: data.map(row => parseFloat(row[header]) || 0),
						backgroundColor: `hsl(${index * 60}, 70%, 60%)`
					}));	
				}
				
				const ctx = document.getElementById("chart").getContext("2d");
				
				if (chartInst)
				{
					chartInst.destroy();
				}
				
				chartInst = new Chart(ctx, {
					type: chartType,
					data: {
						labels: labels,
						datasets: datasets
					},
					options: {
						responsive: true,
						scales: chartType !== "pie" ? { y: { beginAtZero: true } } : undefined
					}	
				});	
			}
			
			clearButton.addEventListener("click", () => {
				editor.value = "";
				preview.innerHTML = "(No data loaded)";
				labelSelect.innerHTML = "";
				dataSelect.innerHTML = "";
				colSelect.style.display = "none";
				
				if (chartInst)
				{
					chartInst.destroy();
					chartInst = null;
				}
				
				csvData = [];
				
				clearButton.disabled = true;
			});	
			
			chartSelect.addEventListener("change", () => {
				renderChart(csvData, labelSelect.value, dataSelect.value, chartSelect.value);
			});	
			
			window.electronAPI.onSaveSuccess((filePath) => {
				alert("File Saved To: " + filePath);
			});	
		</script>
	</body>
</html>	